{% extends 'base/base.html' %}

{% block title %}Бронирование - {{ cottage.name }} - Cottage Booking{% endblock %}

{% block extra_css %}
<style>
    /* Стили для валидации дат */
    .form-control.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
    
    .form-control.is-valid {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    
    .booked-dates-warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
    }
    
    .booked-dates-warning .fas {
        color: #f39c12;
    }
    .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 60px 0;
        margin-bottom: 50px;
    }
    
    .booking-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 30px;
    }
    
    .cottage-info {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 30px;
    }
    
    .cottage-image {
        height: 200px;
        background-size: cover;
        background-position: center;
        border-radius: 15px;
        margin-bottom: 20px;
    }
    
    .booking-form {
        padding: 40px;
    }
    
    .form-group {
        margin-bottom: 25px;
    }
    
    .form-label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
    }
    
    .form-control {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 12px 15px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 25px;
        padding: 15px 40px;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
        background: #6c757d;
        border: none;
        border-radius: 25px;
        padding: 15px 40px;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }
    
    .price-summary {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        margin-top: 30px;
    }
    
    .price-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .price-item:last-child {
        border-bottom: none;
        font-weight: bold;
        font-size: 1.2rem;
        color: #667eea;
    }
    
    .amenities-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 15px;
    }
    
    .amenity-badge {
        background: rgba(255,255,255,0.2);
        color: white;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.9rem;
    }
    
    .alert {
        border-radius: 15px;
        border: none;
        padding: 20px;
        margin-bottom: 25px;
    }
    
    .alert-success {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
    }
    
    .alert-danger {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        color: #721c24;
    }
    
    .text-danger {
        color: #dc3545 !important;
        font-size: 0.9rem;
        margin-top: 5px;
    }
    
    .required {
        color: #dc3545;
    }
    
    
    
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto text-center">
                <h1 class="display-5 fw-bold mb-3">Бронирование коттеджа</h1>
                <p class="lead">Заполните форму ниже для создания бронирования</p>
            </div>
        </div>
    </div>
</section>

<!-- Booking Content -->
<section class="container">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="booking-card">
                <!-- Cottage Info -->
                <div class="cottage-info">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <div class="cottage-image" style="background-image: url('/static/images/default-cottage.jpg')">
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h2 class="mb-3">{{ cottage.name }}</h2>
                            <p class="mb-3">{{ cottage.description|truncatechars:150 }}</p>
                            
                            <div class="row mb-3">
                                <div class="col-sm-6">
                                    <strong><i class="fas fa-users me-2"></i>Вместимость:</strong> {{ cottage.capacity }} гостей
                                </div>
                                <div class="col-sm-6">
                                    <strong><i class="fas fa-ruble-sign me-2"></i>Цена за ночь:</strong> {{ cottage.price_per_night }} ₽
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    <strong><i class="fas fa-map-marker-alt me-2"></i>Адрес:</strong> {{ cottage.address }}
                                </div>
                            </div>
                            
                            {% if cottage.amenities.all %}
                                <div class="amenities-list">
                                    {% for amenity in cottage.amenities.all %}
                                        <span class="amenity-badge">{{ amenity.amenity.name }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Booking Form -->
                <div class="booking-form">
                    
                    <h3 class="mb-4">Данные бронирования</h3>
                    
                    <form method="post" id="bookingForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.check_in.id_for_label }}" class="form-label">
                                        Дата заезда <span class="required">*</span>
                                    </label>
                                    {{ form.check_in }}
                                    {% if form.check_in.errors %}
                                        <div class="text-danger">{{ form.check_in.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.check_out.id_for_label }}" class="form-label">
                                        Дата выезда <span class="required">*</span>
                                    </label>
                                    {{ form.check_out }}
                                    {% if form.check_out.errors %}
                                        <div class="text-danger">{{ form.check_out.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.guests.id_for_label }}" class="form-label">
                                        Количество гостей <span class="required">*</span>
                                    </label>
                                    {{ form.guests }}
                                    {% if form.guests.errors %}
                                        <div class="text-danger">{{ form.guests.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.special_requests.id_for_label }}" class="form-label">
                                Особые пожелания
                            </label>
                            {{ form.special_requests }}
                            {% if form.special_requests.errors %}
                                <div class="text-danger">{{ form.special_requests.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Price Summary -->
                        <div class="price-summary">
                            <h5 class="mb-3">Стоимость бронирования</h5>
                            <div class="price-item">
                                <span>Цена за ночь:</span>
                                <span>{{ cottage.price_per_night }} ₽</span>
                            </div>
                            <div class="price-item">
                                <span>Количество ночей:</span>
                                <span id="nightsCount">-</span>
                            </div>
                            <div class="price-item">
                                <span>Общая стоимость:</span>
                                <span id="totalPrice">-</span>
                            </div>
                        </div>
                        
                        <!-- Form Errors -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary me-3">
                                <i class="fas fa-calendar-check me-2"></i>Забронировать
                            </button>
                            <a href="{% url 'cottages:page' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Назад к коттеджам
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('JavaScript загружен');
    
    const checkInInput = document.querySelector('#id_check_in');
    const checkOutInput = document.querySelector('#id_check_out');
    const guestsInput = document.querySelector('#id_guests');
    const nightsCount = document.getElementById('nightsCount');
    const totalPrice = document.getElementById('totalPrice');
    const cottagePrice = parseFloat('{{ cottage.price_per_night|default:"0" }}'.replace(',', '.')) || 0;
    
    console.log('Переменные инициализированы, цена коттеджа:', cottagePrice);
    
    // Функция для валидации дат
    function validateDates() {
        const checkIn = checkInInput ? checkInInput.value : '';
        const checkOut = checkOutInput ? checkOutInput.value : '';
        
        // Убираем предыдущие стили
        if (checkInInput) {
            checkInInput.classList.remove('is-invalid', 'is-valid');
        }
        if (checkOutInput) {
            checkOutInput.classList.remove('is-invalid', 'is-valid');
        }
        
        let isValid = true;
        
        // Простая валидация - проверяем только что даты заполнены
        if (checkIn && checkInInput) {
            checkInInput.classList.add('is-valid');
            checkInInput.setCustomValidity('');
        }
        
        if (checkOut && checkOutInput) {
            checkOutInput.classList.add('is-valid');
            checkOutInput.setCustomValidity('');
        }
        
        return isValid;
    }
    
    // Функция для показа предупреждения о забронированных датах
    function showBookedDatesWarning() {
        if (bookedDates.length > 0) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'alert alert-warning mt-3';
            warningDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Внимание!</strong> Следующие даты уже забронированы: 
                ${bookedDates.slice(0, 5).join(', ')}${bookedDates.length > 5 ? ' и другие...' : ''}
            `;
            
            // Добавляем предупреждение после формы дат
            const dateSection = document.querySelector('.row .col-md-6:first-child').parentElement;
            if (dateSection && !document.querySelector('.booked-dates-warning')) {
                warningDiv.classList.add('booked-dates-warning');
                dateSection.parentElement.insertBefore(warningDiv, dateSection.nextSibling);
            }
        }
    }
    
    // Вызываем расчет при загрузке страницы (на случай если даты уже заполнены)
    setTimeout(function() {
        calculatePrice();
    }, 100);
    
    
    // Добавляем атрибуты для блокировки забронированных дат в полях ввода
    
    
    
    
    function calculatePrice() {
        const checkIn = checkInInput ? checkInInput.value : '';
        const checkOut = checkOutInput ? checkOutInput.value : '';
        
        console.log('Расчет цены:', { checkIn, checkOut, cottagePrice });
        
        if (checkIn && checkOut) {
            const checkInDate = new Date(checkIn);
            const checkOutDate = new Date(checkOut);
            
            console.log('Даты:', { checkInDate, checkOutDate });
            
            if (checkOutDate > checkInDate) {
                const timeDiff = checkOutDate.getTime() - checkInDate.getTime();
                const nights = Math.ceil(timeDiff / (1000 * 3600 * 24));
                const total = nights * cottagePrice;
                
                console.log('Результат расчета:', { nights, total, cottagePrice });
                
                if (nightsCount) {
                    nightsCount.textContent = nights;
                    console.log('Обновлен nightsCount:', nights);
                }
                if (totalPrice) {
                    totalPrice.textContent = total.toLocaleString() + ' ₽';
                    console.log('Обновлен totalPrice:', total.toLocaleString() + ' ₽');
                }
            } else {
                console.log('Дата выезда должна быть позже даты заезда');
                if (nightsCount) nightsCount.textContent = '-';
                if (totalPrice) totalPrice.textContent = '-';
            }
        } else {
            console.log('Не все даты заполнены:', { checkIn, checkOut });
            if (nightsCount) nightsCount.textContent = '-';
            if (totalPrice) totalPrice.textContent = '-';
        }
    }
    
    // Добавляем обработчики событий для полей ввода дат
    if (checkInInput) {
        checkInInput.addEventListener('change', function() {
            validateDates();
            calculatePrice();
        });
        checkInInput.addEventListener('input', function() {
            validateDates();
            calculatePrice();
        });
    }
    
    if (checkOutInput) {
        checkOutInput.addEventListener('change', function() {
            validateDates();
            calculatePrice();
        });
        checkOutInput.addEventListener('input', function() {
            validateDates();
            calculatePrice();
        });
    }
    
    // Добавляем обработчик для поля количества гостей
    if (guestsInput) {
        guestsInput.addEventListener('change', function() {
            calculatePrice();
        });
        guestsInput.addEventListener('input', function() {
            calculatePrice();
        });
    }
    
    // Устанавливаем минимальную дату выезда при выборе даты заезда
    if (checkInInput && checkOutInput) {
        checkInInput.addEventListener('change', function() {
            if (this.value) {
                const checkInDate = new Date(this.value);
                const minCheckOut = new Date(checkInDate);
                minCheckOut.setDate(minCheckOut.getDate() + 1);
                
                checkOutInput.min = minCheckOut.toISOString().split('T')[0];
                
                // Если дата выезда меньше минимальной, сбрасываем её
                if (checkOutInput.value && new Date(checkOutInput.value) <= checkInDate) {
                    checkOutInput.value = '';
                    calculatePrice();
                }
            }
        });
    }
    
    // Валидация количества гостей
    if (guestsInput) {
        guestsInput.addEventListener('input', function() {
            const maxGuests = {{ cottage.capacity }};
            if (parseInt(this.value) > maxGuests) {
                this.setCustomValidity(`Максимальная вместимость: ${maxGuests} гостей`);
            } else {
                this.setCustomValidity('');
            }
        });
    }
    
    // Предотвращаем отправку формы с ошибками
    const bookingForm = document.getElementById('bookingForm');
    if (bookingForm) {
        bookingForm.addEventListener('submit', function(e) {
            const checkIn = checkInInput ? checkInInput.value : '';
            const checkOut = checkOutInput ? checkOutInput.value : '';
            const guests = guestsInput ? guestsInput.value : '';
            
            if (!checkIn || !checkOut || !guests) {
                e.preventDefault();
                alert('Пожалуйста, заполните все обязательные поля');
                return false;
            }
            
            if (new Date(checkOut) <= new Date(checkIn)) {
                e.preventDefault();
                alert('Дата выезда должна быть позже даты заезда');
                return false;
            }
            
            if (parseInt(guests) > {{ cottage.capacity }}) {
                e.preventDefault();
                alert(`Максимальная вместимость коттеджа: {{ cottage.capacity }} гостей`);
                return false;
            }
            
            // Проверяем, не забронированы ли выбранные даты
            if (!validateDates()) {
                e.preventDefault();
                alert('Выбранные даты уже забронированы. Пожалуйста, выберите другие даты.');
                return false;
            }
        });
    }
});
</script>
{% endblock %}
